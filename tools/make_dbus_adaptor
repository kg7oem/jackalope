#!/usr/bin/env bash

set -e
set -x

# I couldn't figure out why this file kept being regenerated by
# cmake and this was the best workaround I could come up with

main() {
    local TEMP_DIR="$1"
    local INPUT_FILE="$2"
    local OUTPUT_FILE="$3"

    if [ ! -e "$OUTPUT_FILE" ]; then
        generate_file "$INPUT_FILE" "$OUTPUT_FILE"
    else
        TEMP_FILE="$TEMP_DIR/$OUTPUT_FILE.tmp"
        generate_file "$INPUT_FILE" "$TEMP_FILE"

        if ! diff "$OUTPUT_FILE" "$TEMP_FILE"; then
            cp "$TEMP_FILE" "$OUTPUT_FILE"
        fi
    fi
}

generate_file() {
    dbusxx-xml2cpp "$1" "--adaptor=$2"
}

main "$@"
